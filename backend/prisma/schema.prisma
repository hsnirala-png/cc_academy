generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum Role {
  ADMIN
  STUDENT
}

enum ClassMode {
  ONLINE
  OFFLINE
  HYBRID
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum ExamType {
  PSTET_1
  PSTET_2
}

enum StreamChoice {
  SCIENCE_MATH
  SOCIAL_STUDIES
}

enum QuestionLanguage {
  PUNJABI
  ENGLISH
  HINDI
}

enum MockSubject {
  PUNJABI
  ENGLISH
  CHILD_PEDAGOGY
  MATHS_EVS
  SCIENCE_MATH
  SOCIAL_STUDIES
}

enum MockOption {
  A
  B
  C
  D
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
}

enum ReferralPayoutMethodType {
  BANK
  UPI
}

enum ReferralWithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReferralTransactionType {
  REFERRAL_BONUS
  PRODUCT_PURCHASE
  WITHDRAWAL
}

model User {
  id           String   @id @default(cuid())
  name         String
  mobile       String   @unique
  email        String?  @unique
  state        String
  city         String
  passwordHash String
  role         Role     @default(STUDENT)
  mockTestsCreated MockTest[] @relation("MockTestsCreatedBy")
  productsCreated Product[] @relation("ProductsCreatedBy")
  referralCode String? @unique
  referrerId String?
  referrer User? @relation("UserReferrals", fields: [referrerId], references: [id], onDelete: SetNull)
  referredUsers User[] @relation("UserReferrals")
  enrollments  Enrollment[]
  lessonProgress LessonProgress[]
  attempts     Attempt[]
  subscriptions StudentSubscription[]
  referralPayoutMethods ReferralPayoutMethod[]
  referralTransactions ReferralTransaction[]
  referralWithdrawals ReferralWithdrawal[]
  productPurchases ProductPurchase[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([referrerId])
  @@index([referralCode])
}

model Course {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  isActive    Boolean      @default(true)
  chapters    Chapter[]
  enrollments Enrollment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([isActive, title])
}

model Chapter {
  id          String    @id @default(cuid())
  courseId    String
  title       String
  description String?   @db.Text
  orderIndex  Int
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([courseId, orderIndex])
  @@index([courseId, title])
}

model Lesson {
  id               String          @id @default(cuid())
  chapterId        String
  title            String
  orderIndex       Int
  videoUrl         String
  transcriptUrl    String?
  transcriptText   String?         @db.LongText
  transcriptSegments Json?
  audioUrl         String?
  audioDurationMs  Int?
  audioGeneratedAt DateTime?
  audioStatus      String?
  audioVoice       String?         @default("marin")
  audioLanguageHint String?
  durationSec      Int             @default(0)
  assessmentTestId String?
  chapter          Chapter         @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  assessmentTest   MockTest?       @relation(fields: [assessmentTestId], references: [id], onDelete: SetNull)
  progress         LessonProgress[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([chapterId, orderIndex])
  @@index([chapterId, title])
  @@index([assessmentTestId])
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
}

model LessonProgress {
  id              String   @id @default(cuid())
  userId          String
  lessonId        String
  lastPositionSec Int      @default(0)
  completed       Boolean  @default(false)
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId, completed])
}

model Product {
  id            String   @id @default(cuid())
  title         String
  examCategory  String
  examName      String
  courseType    String
  languageMode  String?
  thumbnailUrl  String?
  description   String?  @db.Text
  listPrice     Decimal  @db.Decimal(10, 2)
  salePrice     Decimal  @db.Decimal(10, 2)
  referralBonusAmount Decimal @default(0) @db.Decimal(10, 2)
  referralDiscountAmount Decimal @default(0) @db.Decimal(10, 2)
  accessDays    Int
  validityLabel String?
  addons        Json?
  isActive      Boolean  @default(true)
  createdBy     String?
  createdByUser User?    @relation("ProductsCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  purchases     ProductPurchase[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, examCategory, examName, courseType, languageMode])
  @@index([createdBy])
}

model CoachingClass {
  id           String   @id @default(cuid())
  name         String
  description  String?
  instructor   String?
  mode         ClassMode @default(ONLINE)
  startDate    DateTime
  endDate      DateTime?
  seats        Int?
  isActive     Boolean   @default(true)
  subscriptions StudentSubscription[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  title         String
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  durationDays  Int
  isActive      Boolean  @default(true)
  subscriptions StudentSubscription[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model StudentSubscription {
  id         String             @id @default(cuid())
  userId     String
  planId     String
  classId    String?
  startsOn   DateTime           @default(now())
  endsOn     DateTime?
  status     SubscriptionStatus @default(ACTIVE)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan       SubscriptionPlan   @relation(fields: [planId], references: [id], onDelete: Restrict)
  classItem  CoachingClass?     @relation(fields: [classId], references: [id], onDelete: SetNull)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@index([userId])
  @@index([planId])
  @@index([classId])
}

model MockTest {
  id          String       @id @default(cuid())
  title       String
  examType    ExamType
  subject     MockSubject
  streamChoice StreamChoice?
  languageMode QuestionLanguage?
  isActive    Boolean      @default(true)
  createdBy   String
  createdByUser User       @relation("MockTestsCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  questions   Question[]
  sections    MockTestSection[]
  attempts    Attempt[]
  linkedLessons Lesson[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([examType, subject, streamChoice, isActive])
  @@index([createdBy])
}

model MockTestSection {
  id            String    @id @default(cuid())
  mockTestId    String
  sectionLabel  String    @db.VarChar(120)
  sectionType   String    @default("GENERAL_MCQ") @db.VarChar(60)
  transcriptText String?  @db.LongText
  audioUrl      String?   @db.VarChar(512)
  questionLimit Int       @default(10)
  sortOrder     Int       @default(0)
  isActive      Boolean   @default(true)
  mockTest      MockTest  @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([mockTestId, sectionLabel])
  @@index([mockTestId, sortOrder, isActive])
}

model Question {
  id           String      @id @default(cuid())
  mockTestId   String
  questionText String      @db.Text
  optionA      String      @db.Text
  optionB      String      @db.Text
  optionC      String      @db.Text
  optionD      String      @db.Text
  correctOption MockOption
  explanation  String?     @db.Text
  sectionLabel String?     @db.VarChar(120)
  isActive     Boolean     @default(true)
  mockTest     MockTest    @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  attemptQuestions AttemptQuestion[]
  attemptAnswers AttemptAnswer[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([mockTestId, isActive])
  @@index([mockTestId, sectionLabel, isActive])
}

model Attempt {
  id            String        @id @default(cuid())
  userId        String
  mockTestId    String
  status        AttemptStatus @default(IN_PROGRESS)
  totalQuestions Int
  correctCount  Int?
  scorePercent  Float?
  remarkText    String?
  startedAt     DateTime      @default(now())
  submittedAt   DateTime?
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  mockTest      MockTest      @relation(fields: [mockTestId], references: [id], onDelete: Restrict)
  attemptQuestions AttemptQuestion[]
  answers       AttemptAnswer[]

  @@index([userId, startedAt])
  @@index([mockTestId, startedAt])
  @@index([status, submittedAt])
}

model AttemptQuestion {
  id         String   @id @default(cuid())
  attemptId  String
  questionId String
  orderIndex Int
  attempt    Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Restrict)

  @@unique([attemptId, questionId])
  @@unique([attemptId, orderIndex])
  @@index([questionId])
}

model AttemptAnswer {
  id            String     @id @default(cuid())
  attemptId      String
  questionId     String
  selectedOption MockOption
  answeredAt     DateTime   @default(now())
  attempt        Attempt    @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question   @relation(fields: [questionId], references: [id], onDelete: Restrict)

  @@unique([attemptId, questionId])
  @@index([questionId])
}

model ProductPurchase {
  id            String   @id @default(cuid())
  userId        String
  productId     String
  amountPaid    Decimal  @db.Decimal(10, 2)
  walletUsed    Decimal  @db.Decimal(10, 2)
  referralBonusCredited Decimal @default(0) @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  referralTransactions ReferralTransaction[]

  @@index([userId, createdAt])
  @@index([productId, createdAt])
}

model ReferralPayoutMethod {
  id           String                   @id @default(cuid())
  userId       String
  type         ReferralPayoutMethodType
  bankName     String?
  accountNo    String?
  ifsc         String?
  place        String?
  upiId        String?
  isVerified   Boolean                  @default(false)
  verifiedAt   DateTime?
  verifiedBy   String?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  user         User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawals  ReferralWithdrawal[]

  @@index([userId, createdAt])
  @@index([isVerified, type])
}

model ReferralWithdrawal {
  id             String                    @id @default(cuid())
  userId         String
  payoutMethodId String
  amount         Decimal                   @db.Decimal(10, 2)
  status         ReferralWithdrawalStatus  @default(PENDING)
  requestedAt    DateTime                  @default(now())
  reviewedAt     DateTime?
  reviewedBy     String?
  adminNote      String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payoutMethod   ReferralPayoutMethod      @relation(fields: [payoutMethodId], references: [id], onDelete: Restrict)
  referralTransactions ReferralTransaction[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model ReferralTransaction {
  id            String                 @id @default(cuid())
  userId        String
  amount        Decimal                @db.Decimal(10, 2)
  type          ReferralTransactionType
  description   String?
  purchaseId    String?
  withdrawalId  String?
  createdAt     DateTime               @default(now())
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchase      ProductPurchase?       @relation(fields: [purchaseId], references: [id], onDelete: SetNull)
  withdrawal    ReferralWithdrawal?    @relation(fields: [withdrawalId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([purchaseId])
  @@index([withdrawalId])
}
